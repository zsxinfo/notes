## 2.进程与线程

OS最核心的概念：进程。

### 2.1 进程

- 伪并行：每个进程各运行几十或几百毫秒，CPU快速切换。
- 多处理器系统：2+CPU共享同一个物理内存。

人们很难对多个并行活动进行跟踪，因此，经过多年女里，OS设计者develop一种描述并行的概念模型（顺序进程），使得并行更容易处理。

进程模型

计算机上所有可运行的软件，通常也包括OS，被组织成若干**顺序进程**（sequential process），简称**进程**（process）。CPU在程序间来回切换，被称为**多道程序设计**。

4个事件导致进程的创建：

1. 系统初始化
2. 正在运行的程序执行了创建进程的系统调用
3. 用户请求创建一个新进程
4. 一个批处理作业的初始化

停留在后台处理的进程叫做守护进程（daemon）的查看：
- unix：ps程序
- win：任务管理器

Unix：只有一个系统调用可以用来创建新进程：fork。fork之后，执行execve或者类似的调用。

Win：CreateProcess既处理进程的创建，也负责把正确的程序装入新的进程。该调用有10个参数。

1. 要执行的程序
2. 输入给该程序的命令行参数
3. 各种安全属性
4. 有关打开的文件是否继承的控制位
5. 优先级信息
6. 该进程（若有的话）所需要创建的窗口规格
7. 以及指向一个结构的指针，在该结构中新创建进程的信息被返回给调用者。

可写的内存不可以共享。

进程终止：

1. 正常退出（自愿 exit : ExitProcess
2. 出错退出（自愿
3. 严重错误（非自愿
4. 被其他进程杀死（非自愿 kill : TerminateProcess

进程的三个状态：
a. 运行态
b. 阻塞态
c. 就绪态

运行 --1-->阻塞

运行 --2-->就绪

就绪 --3-->运行

阻塞 --4-->就绪

OS发现进程不能在这样下去，就发生1。或者进程等待读取设备文件，发生1。

进程调度程序引起2和3。进程调度算法：力图在整体效率和进程的公平竞争之间取得平衡。

当进程等待的外部事件发生时，发生转换4。

#### 进程的实现

进程表：process table

进程管理：
- 寄存器
- 程序计数器
- 程序状态字
- 堆栈指针
- 进程状态
- 优先级
- 调度参数
- 进程ID
- 父进程
- 进程组
- 信号
- 进程开始时间
- 使用的CPU时间
- 子进程的CPU时间
- 下次定时器时间

存储管理：
- 正文段指针
- 数据段指针
- 堆栈段指针

文件管理
- 根目录
- 工作目录
- 文件描述符
- 用户ID
- 组ID

中断向量：interrupt vector

中断发生后OS最底层的工作步骤：
1. 硬件压入堆栈程序计数器等。
2. 硬件从中断向量装入新的程序计数器。
3. 汇编语言过程保存寄存器值。
4. 汇编语言过程设置新的堆栈。
5. C中断服务例程运行（典型地读和缓冲输入）
6. 调度程序决定下一个将运行的进程。
7. C过程返回至汇编代码。
8. 汇编语言过程开始运行新的当前进程。

### 2.2 线程 thread

迷你的进程：线程：同一个地址空间中准并行运行多个控制线程的情形。

为什么需要线程？

主要原因：在许多app中，同时发生多种活动。其中某些活动随着时间的推移会被阻塞。通过将这些app分解成可以准并行运行的多个顺序线程，程序设计模型会变得简单。

有了进程模型的抽象，我们不必考虑中断、定时器和上下文切换（交给OS了），而只需要考虑自己的进程。

有了多线程模型的抽象，并行的实体才可以操作同一个地址空间，这是进程模型无法表达的。

第二个原因：线程比进程更轻量级，更快创建，更快撤销。

第三个原因：性能。如果多个线程都是CPU密集计算的，那么不能获得性能增强。如果有大量计算和大量IO处理，拥有多个线程允许这些活动彼此重叠，加快速度。

有限状态机：finite-state machine

三种方法：
- 多线程
- 单线程进程
- 有限状态机：非阻塞系统调用

#### 经典线程模型

轻量级的进程（lightweight process）

线程之间没有保护的，原因：
1. 不可能
2. 没必要

#### POSIX线程

- pthread_create
- pthread_exit
- pthread_join
- pthread_yield
- pthread_attr_init
- pthread_attr_destroy

#### 线程的实现

- 用户态的线程实现
- 内核中的线程实现 
- 混合实现

#### 调度程序激活 scheduler activation 机制

上行调用upcall

## 2.3 进程间通信






































